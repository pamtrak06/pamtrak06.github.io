<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="chrome=1">
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width">
        <meta name="description" content="Leaflet and Meteo-France geoservices">

        <!-- JQUERY -->
        <script src="js/jquery-3.1.1.min.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <!--script src="js/jquery.mobile-1.4.5.min.js"></script-->
        <!-- JQUERY -->

        <!-- BOOTSTRAP -->
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u">
        <!-- Optional theme -->
        <link rel="stylesheet" href="css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp">
        <!-- Latest compiled and minified JavaScript -->
        <script src="js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"></script>

        <link rel="stylesheet" href="css/font-awesome.min.css">
        <!-- BOOTSTRAP -->

        <!--link rel="stylesheet" href="css/query.css"-->
        <link rel="stylesheet" href="css/properties.css">

        <!-- LEAFLET -->
        <link rel="stylesheet" href="css/leaflet.css" />
        <script src="js/leaflet.js"></script>

        <style>
      		#map {
      			width: 1000px;
      			height: 400px;
            margin: 50px auto;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,.16);
            border-radius: 20px;
      		}
          body {
      			padding-left: 60px;
      		}

          select {
      			height: 40px;
      		}

      		.input-username, .input-password, .checkbox_remember, .login-button {
      			margin-top:15px;
      		}
      	</style>
        <!-- LEAFLET -->

        <!-- OPENLAYERS3 -->
        <script src="../ol.js" type="text/javascript"></script>
        <!-- OPENLAYERS3 -->

        <!--script>
          // clear session storage key
          // TODO manage asynchronous process: clear session au reload geojson
          // localStorage.clear();
          // sessionStorage.clear();
        </script-->

        <title>Web Map viewer</title>
        <!--noscript>Your media does not support JavaScript!</noscript-->
    </head>

    <body onload="init();">

      <div class="row">
        <div class="col-xs-6">

          <div id="map"></div>

          <!--div class="row">
              <div class="col-xs-3">
                <div class="loading-progress"></div>
              </div>
          </div-->
          <!--div class="loading-progress"></div-->
          <div>
            <table>
              <thead>
                <tr>
                  <th colspan="3">Meteo-France geoservices properties</th>
                </tr>
                <tr>
                  <th>Properties</th>
                  <th colspan="2">Description</th>
                </tr>
              </thead>
              <tbody>
                <!-- TODO: Meteo-France API restful webservices -->
                <!--label for="login" class="sr-only">Login</label>
                <input type="login" id="username" class="form-control" placeholder="User name" required autofocus>
                <label for="login" class="sr-only">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Password" required>
                <div class="checkbox">
                  <label>
                    <input type="checkbox" value="remember-me"> Remember me
                  </label>
                </div>
                <button class="btn btn-lg btn-primary btn-block" id="tokenizer" type="submit">Tokenize</button-->
                <tr>
                  <td>Meteo-France API token</td>
                  <td>
                    <input type="login" id="token" class="form-control" placeholder="Meteo-France API token" required autofocus>
                  </td>
                </tr>
                <tr>
                  <td>Geoservice</td>
                  <td>
                    <select id="geoservices" class="parameter">
                      <option></option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <td>Capabilities</td>
                  <td><div id="lbgeoservice"/></td>
                </tr>

                <tr>
                  <td>Layer Name</td>
                  <td>
                    <div>
                      <select id="layers" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Style Name</td>
                  <td>
                    <div>
                      <select id="styles" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Time</td>
                  <td>
                    <div>
                      <select id="times" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Reference time</td>
                  <td>
                    <div>
                      <select id="referenceTimes" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Format</td>
                  <td>
                    <div>
                      <select id="formats" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Bounding box</td>
                  <td>
                    <div>
                      <select id="boundingBox" class="parameter">
                        <option></option>
                      </select>
                    </div>
                  </td>
                </tr>

                <tr>
                  <td>Load map</td>
                  <td>
                    <!--button class="btn btn-lg btn-primary btn-block" id="loadMap" type="submit">Load WMS Map layer</button-->
                    <button type="button" id="loadMap" class="btn btn-primary">Load WMS Map layer</button>
                  </td>
                </tr>

                <tr>
                  <td>Site</td>
                  <td><div id="lbsite"/></td>
                </tr>

                <tr>
                  <td>Documentation</td>
                  <td><div id="lbdocumentation"/></td>
                </tr>

                <tr>
                  <td>License</td>
                  <td><div id="lblicense"/></td>
                </tr>

                <tr>
                  <td>Mention</td>
                  <td><div id="lbmention"/></td>
                </tr>

              </tbody>
            </table>
          </div>
        </div>

        <div style="visibility: hidden;" id="capabilities" name="capabilities"></div>
        <div style="visibility: hidden;" id="geojson" name="geojson"></div>
      </div>

      <!--div class="row">
        <div class="col-xs-6">
          <legend>WMS capabilities</legend>
          <div>
              <form>
                  <textarea id="capabilities" name="capabilities"></textarea>
              </form>
          </div>
        </div>
        <div class="col-xs-6">
          <legend>MF Geoservices (geojson)</legend>
          <div>
              <form>
                  <textarea id="geojson" name="geojson"></textarea>
              </form>
          </div>
        </div>
      </div-->

      <!--div id="geojsonShoreline" /-->


      <script crossorigin="anonymous">
        // --------------------------------------------
        // Initialisation
        // --------------------------------------------
        init=(function() {

          // Initialize list of Meteo-France WMS geoservice
          loadGeojsonServices("geoservices.geojson");

        });

        // --------------------------------------------
        // UI events
        // --------------------------------------------

        // Fire-event: loading geojson
        $("#geojson").on("change", function () {
          var geojson = getStore("geojson");
          populateGeoservicesOptions(geojson);
        });

        // Fire-event: loading WMS capabilities
        $("#capabilities").on("change", function () {

          var mapLayers = getStore("mapLayers");
          populateLayersOptions(mapLayers);
          populateStylesOptions(mapLayers);
          populateTimesOptions(mapLayers);
          populateRefTimesOptions(mapLayers);
          populateFormatsOptions(mapLayers);
          populateBoundingBoxOptions(mapLayers);

        });

        // Fire-event: select WMS geoservice
        $("#geoservices").on("change", function () {

            clearLayersOptions();
            clearStylesOptions();
            clearReferenceTimesOptions();
            clearTimesOptions();
            clearFormatsOptions();
            clearBoundingBoxOptions();

            var url = $("#geoservices").val();
            var token = $("#token").val();
            url = url + "request=GetCapabilities&version=1.3.0&service=WMS&token=" + token;

            var geoserviceSelected = $("#geoservices option:selected").val();
            //$("#lbgeoservice").text(geoserviceSelected);
            $("#lbgeoservice").html("<a target=\"_blank\" href=\"" + url + "\">" + $("#geoservices").val() + "</a>");
            $("#lblayer").text($("#layers option:selected").text());
            $("#lbtime").text($("#times option:selected").text());
            $("#lbreftime").text($("#reftimes option:selected").text());
            $("#lbformat").text($("#formats option:selected").text());
            $("#lbstyle").text($("#styles option:selected").text());

            // Read from geojson
            $("#lbdocumentation").html("<a target=\"_blank\" href=\"" + getGeojsonDoc(geoserviceSelected) + "\">" + getGeojsonDoc(geoserviceSelected) + "</a>");
            $("#lblicense").html("<a target=\"_blank\" href=\"" + getGeojsonLic(geoserviceSelected) + "\">" + getGeojsonLic(geoserviceSelected) + "</a>");
            $("#lbmention").text(getGeojsonMention(geoserviceSelected));
            $("#lbsite").html("<a target=\"_blank\" href=\"" + getGeojsonSite(geoserviceSelected) + "\">" + getGeojsonSite(geoserviceSelected) + "</a>");
            $("#lbdescription").text(getGeojsonDescription(geoserviceSelected));

            if (!isGeoservicesEmpty() && !isTokenEmpty()) {

                var geoserviceName = getGeojsonName(geoserviceSelected);
                populateMapOptionsFromCapabilities(url, geoserviceName);

            } else {

              var msg = "";
              if (isTokenEmpty()) {
                msg = "Token must not be empty !";
              }
              console.error(msg);
              alert(msg);

              // select first which is empty string
              $("#geoservices").val($("#geoservices option:first").val());

            }

            //$("#lbgeoservice").text(geoserviceSelected);

        });

        // Fire-event: select WMS layer for selected geoservice
        $("#layers").on("change", function () {
            var mapLayers = getStore("mapLayers");
            populateStylesOptions(mapLayers);
            $("#lblayer").text($("#layers option:selected").text());
            $("#lbstyle").text($("#styles option:selected").text());
            $("#lbtime").text($("#times option:selected").text());
            $("#lbreftime").text($("#reftimes option:selected").text());
            $("#lbformat").text($("#formats option:selected").text());
        });

        // Fire-event: select WMS layer from seleted layer of selected geoservice
        $("#styles").on("change", function () {
            $("#lbstyle").text($("#styles option:selected").text());
        });

        // Fire-event: call API key
        // TODO to activate or not ???
        $("#tokenizer").click(function () {
            var username = $("#username").val()
            var password = $("#password").val()
            getToken(username, password);
        });

        // Fire-event: set token API
        // $("#token").on("change",function () {
        //     token = $("#token").val();
        // });

        // Fire-event: load map
        $("#loadMap").click(function () {
          // load Geojson shoreline asynchronously
          //TODO:  to be reactivated
          // var geoserviceSelected = $("#geoservices option:selected").text();
          // var geojsonFile = getGeojsonRessource(geoserviceSelected);
          // key = geojsonFile.split("\\").pop().split("/").pop();
          // loadGeojsonShoreline(geojsonFile, key);

          var geoserviceSelected = $("#geoservices option:selected").val();

          if (isTokenEmpty() || isGeoservicesEmpty() || isLayersEmpty() || isStylesEmpty()) {
            var msg = "One of parameters: token, geoservices, layers, styles is missing !";
            console.error(msg);
            alert(msg);
          } else {
            var layer = $("#layers").val();
            var style = $("#styles").val();
            var time = $("#times").val();
            var bbox = $("#boundingBox").val();
            var reftime = $("#referenceTimes").val();
            var format = $("#formats").val();
            var token = $("#token").val();
            var url = $("#geoservices").val() + "token=" + token;
            // var boundingbox = getGeojsonCoordinates(geoserviceSelected);
            if (!isTokenEmpty()) {

              loadWmsMap(url, layer, style, time, reftime, format, bbox);


              // var geojsonFile = getGeojsonRessource(geoserviceSelected)
              // key = geojsonFile.split("\\").pop().split("/").pop()
              // var geojsonFeature = loadGeojsonShoreline(geojsonFile, key);
              // loadWmsMap(url, layer, style, boundingbox, geojsonFeature);

              // TODO: bug with addnig geojson after
              //addGeojsonToMap(getGeojsonRessource(geoserviceSelected));
            }
          }
        });

        // TODO bug
        // Fire-event: loading geojson shoreline
        // $("#geojsonShoreline").on("change", function () {
        //     //Read from query interface
        //     var geoserviceSelected = $("#geoservices option:selected").text();
        //     var geojsonFile = getGeojsonRessource(geoserviceSelected);
        //     key = geojsonFile.split("\\").pop().split("/").pop();
        //     addGeojsonToMap(key);
        // });

      </script>

      <!-- Meteo-France geoservices -->
      <script src="geoservices.js"></script>
      <!-- Meteo-France geoservices -->


      <!--script src="js/jquery.progresstimer.js" />
      <script>
          var progress = $(".loading-progress").progressTimer({
              timeLimit: 60,
              onFinish: function () {
                  alert("completed!");
              }
          });
      </script-->

    </body>
</html>
